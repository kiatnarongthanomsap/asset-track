# คู่มือการอัพเดทหน้าตั้งค่าระบบ

## สรุปการปรับปรุง

หน้าตั้งค่าระบบได้รับการปรับปรุงให้เชื่อมต่อกับ Supabase อย่างสมบูรณ์แล้ว

## การติดตั้ง

### 1. รัน Migration Scripts

#### 1.1 สร้างตาราง Settings

รัน SQL script ต่อไปนี้ใน Supabase SQL Editor:

```sql
-- ไฟล์: migration_create_settings_table.sql
```

Script นี้จะ:
- สร้างตาราง `settings` สำหรับเก็บการตั้งค่าระบบ
- เพิ่มข้อมูลเริ่มต้นสำหรับการตั้งค่าต่างๆ
- สร้าง trigger สำหรับอัพเดท `updated_at` อัตโนมัติ

### 2. ตรวจสอบ Schema

หลังจากรัน migration แล้ว ตรวจสอบว่า schema ถูกต้อง:

```sql
SELECT * FROM settings ORDER BY category, setting_key;
```

## ฟีเจอร์ที่ปรับปรุง

### 1. ตั้งค่าทั่วไป (General Settings)
- ✅ ชื่อสหกรณ์/หน่วยงาน - บันทึกลง Supabase
- ✅ ปีระบบปัจจุบัน - บันทึกลง Supabase
- ✅ โหลดค่าจากฐานข้อมูลเมื่อเปิดหน้า

### 2. หมวดหมู่ทรัพย์สิน (Categories)
- ✅ เพิ่มหมวดหมู่ใหม่ - บันทึกลง Supabase
- ✅ แก้ไขหมวดหมู่ - อัพเดทใน Supabase
- ✅ ลบหมวดหมู่ - ลบจาก Supabase (ตรวจสอบว่ามีทรัพย์สินใช้หรือไม่)
- ✅ จัดการ Icon สำหรับหมวดหมู่
- ✅ จัดการอายุใช้งาน (useful_life)

### 3. รหัสทรัพย์สิน (Numbering)
- ✅ รูปแบบรหัส (Pattern) - บันทึกลง Supabase
- ✅ เลขเริ่มต้น (Start Number) - บันทึกลง Supabase
- ✅ จำนวนหลักเลขรัน (Padding) - บันทึกลง Supabase
- ✅ Preview รูปแบบรหัสแบบ Real-time

### 4. การคำนวณค่าเสื่อม (Depreciation)
- ✅ วิธีคำนวณ (Method) - บันทึกลง Supabase
- ✅ มูลค่าซากขั้นต่ำ (Scrap Value) - บันทึกลง Supabase
- ✅ การปัดเศษ (Rounding) - บันทึกลง Supabase

### 5. ผู้ใช้งานและสิทธิ์ (Users & Permissions)
- ✅ จัดการผู้ใช้ (CRUD)
- ✅ กำหนดบทบาทและสิทธิ์
- ✅ ตรวจสอบสิทธิ์ก่อนทำการต่างๆ

### 6. ฐานข้อมูลและนำเข้า (Database & Import)
- ✅ ส่งออกข้อมูลเป็น CSV
- ✅ นำเข้าข้อมูลจาก CSV - เชื่อมต่อกับ Supabase
- ✅ ล้างข้อมูลทรัพย์สิน - ลบจาก Supabase (ต้องมีสิทธิ์)
- ✅ ตรวจสอบสิทธิ์ก่อนนำเข้า/ลบข้อมูล

## ฟังก์ชันที่เพิ่มใน supabaseService.js

### Categories
- `saveCategory(category)` - บันทึก/อัพเดทหมวดหมู่
- `deleteCategory(categoryId)` - ลบหมวดหมู่ (ตรวจสอบว่ามีทรัพย์สินใช้หรือไม่)

### Settings
- `fetchSettings(category)` - ดึงการตั้งค่าทั้งหมดหรือตาม category
- `getSetting(key, defaultValue)` - ดึงค่าการตั้งค่าตาม key
- `saveSetting(key, value, type, description, category)` - บันทึกการตั้งค่าเดียว
- `saveSettings(settingsArray)` - บันทึกการตั้งค่าหลายรายการพร้อมกัน

## การใช้งาน

### บันทึกการตั้งค่า

1. ไปที่ **ตั้งค่าระบบ**
2. ปรับแต่งการตั้งค่าตามต้องการ
3. คลิก **บันทึกการตั้งค่า** ที่มุมขวาบน
4. ระบบจะบันทึกการตั้งค่าทั้งหมดลง Supabase

### จัดการหมวดหมู่

1. ไปที่ **ตั้งค่าระบบ** > **หมวดหมู่ทรัพย์สิน**
2. คลิก **เพิ่มหมวดใหม่** เพื่อสร้างหมวดหมู่ใหม่
3. ใช้ปุ่ม **แก้ไข** เพื่อแก้ไขหมวดหมู่
4. ใช้ปุ่ม **ลบ** เพื่อลบหมวดหมู่ (จะตรวจสอบว่ามีทรัพย์สินใช้หรือไม่)

### นำเข้าข้อมูล

1. ไปที่ **ตั้งค่าระบบ** > **ฐานข้อมูลและนำเข้า**
2. คลิก **ดาวน์โหลด Template** เพื่อดาวน์โหลดไฟล์ CSV template
3. กรอกข้อมูลในไฟล์ CSV
4. ลากไฟล์มาวางหรือคลิกเพื่อเลือกไฟล์
5. ระบบจะนำเข้าข้อมูลลง Supabase อัตโนมัติ

## Security Notes

⚠️ **หมายเหตุสำคัญ**:
- การลบข้อมูลทรัพย์สินต้องมีสิทธิ์ `manage_assets`
- การนำเข้าข้อมูลต้องมีสิทธิ์ `import_assets`
- การจัดการหมวดหมู่ต้องมีสิทธิ์ `manage_assets` หรือ `settings`
- การแก้ไขการตั้งค่าระบบต้องมีสิทธิ์ `settings`

## Troubleshooting

### ปัญหา: ไม่สามารถบันทึกการตั้งค่าได้

1. ตรวจสอบว่า migration script รันสำเร็จแล้ว
2. ตรวจสอบว่ามีตาราง `settings` ในฐานข้อมูล
3. ตรวจสอบสิทธิ์ผู้ใช้ (ต้องมีสิทธิ์ `settings`)

### ปัญหา: ไม่สามารถลบหมวดหมู่ได้

1. ตรวจสอบว่ามีทรัพย์สินที่ใช้หมวดหมู่นี้หรือไม่
2. ถ้ามีทรัพย์สิน ต้องลบหรือเปลี่ยนหมวดหมู่ของทรัพย์สินก่อน

### ปัญหา: ไม่สามารถนำเข้าข้อมูลได้

1. ตรวจสอบสิทธิ์ผู้ใช้ (ต้องมีสิทธิ์ `import_assets`)
2. ตรวจสอบรูปแบบไฟล์ CSV
3. ตรวจสอบว่ามีข้อมูลที่ถูกต้องในไฟล์

## Next Steps

1. ✅ รัน migration script สำหรับตาราง settings
2. ✅ ทดสอบการบันทึกการตั้งค่าต่างๆ
3. ✅ ทดสอบการจัดการหมวดหมู่
4. ✅ ทดสอบการนำเข้าข้อมูล
5. ⚠️ พิจารณาเพิ่มการสำรองข้อมูลอัตโนมัติ

